services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sefaz_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - .:/var/www/html
      - vendor_data:/var/www/html/vendor
      - bootstrap_cache_data:/var/www/html/bootstrap/cache
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/database/database.sqlite
      - SANCTUM_STATEFUL_DOMAINS=localhost:5174,localhost,127.0.0.1:5174,127.0.0.1
      - SESSION_DRIVER=cookie
      - SESSION_DOMAIN=localhost
    command: >
      sh -c "
        echo '=== Verificando dependências PHP ===' &&
        # Verificar se vendor existe e tem conteúdo
        if [ ! -d vendor ] || [ ! -f vendor/autoload.php ] || [ ! -d vendor/laravel ]; then
          echo 'Instalando dependências PHP...' &&
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-scripts &&
          composer dump-autoload --optimize &&
          echo 'Dependências PHP instaladas!'
        else
          echo 'Dependências PHP já instaladas.'
        fi &&
        echo '=== Configurando aplicação ===' &&
        # Criar .env se não existir
        if [ ! -f .env ]; then
          echo 'Criando arquivo .env...' &&
          cp .env.example .env 2>/dev/null || echo 'APP_KEY=' > .env
        fi &&
        # Executar package:discover
        php artisan package:discover --ansi || true &&
        # Gerar chave da aplicação se necessário
        php artisan key:generate --force 2>/dev/null || true &&
        # Criar banco de dados SQLite se não existir
        mkdir -p database &&
        touch database/database.sqlite &&
        # Executar migrations
        php artisan migrate --seed --force 2>/dev/null || true &&
        echo '=== Iniciando servidor Laravel ===' &&
        # Iniciar Laravel
        php artisan serve --host=0.0.0.0 --port=8000
      "

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sefaz_frontend
    restart: unless-stopped
    ports:
      - "5174:5174"
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - backend

volumes:
  vendor_data:
  frontend_node_modules:
  bootstrap_cache_data:
